name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore backend/Ticketing.Backend/src/Ticketing.Api/Ticketing.Api.csproj
      working-directory: ${{ github.workspace }}
    
    - name: Build
      run: dotnet build backend/Ticketing.Backend/src/Ticketing.Api/Ticketing.Api.csproj --no-restore
      working-directory: ${{ github.workspace }}
    
    - name: Run migrations
      run: |
        cd backend/Ticketing.Backend
        dotnet ef database update --project ./src/Ticketing.Infrastructure/Ticketing.Infrastructure.csproj --startup-project ./src/Ticketing.Api/Ticketing.Api.csproj --no-build
      working-directory: ${{ github.workspace }}
    
    - name: Start backend server
      run: |
        cd backend/Ticketing.Backend
        dotnet run --project ./src/Ticketing.Api/Ticketing.Api.csproj --no-build &
        echo $! > backend.pid
      working-directory: ${{ github.workspace }}
    
    - name: Wait for backend
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:5000/swagger/index.html; do sleep 2; done'
    
    - name: Run backend smoke tests
      shell: pwsh
      run: |
        cd ${{ github.workspace }}
        pwsh -File tools/run-smoke-tests.ps1 -BaseUrl "http://localhost:5000"
    
    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend/Ticketing.Backend/backend.pid ]; then
          kill $(cat backend/Ticketing.Backend/backend.pid) || true
        fi
        pkill -f "dotnet.*Ticketing.Api" || true
      working-directory: ${{ github.workspace }}
    
    - name: Upload smoke test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-smoke-report
        path: RUNTIME_SMOKE_REPORT.md
        retention-days: 7

  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: npm ci
      working-directory: frontend
    
    - name: Build
      run: npm run build
      working-directory: frontend
      env:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:5000
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      working-directory: frontend
    
    - name: Start backend server (for frontend tests)
      run: |
        cd backend/Ticketing.Backend
        dotnet run --project ./src/Ticketing.Api/Ticketing.Api.csproj --no-build &
        echo $! > backend.pid
      working-directory: ${{ github.workspace }}
    
    - name: Wait for backend
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:5000/swagger/index.html; do sleep 2; done'
    
    - name: Run Playwright tests
      run: npm run test:e2e || npx playwright test e2e/smoke.spec.ts
      working-directory: frontend
      env:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:5000
    
    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend/Ticketing.Backend/backend.pid ]; then
          kill $(cat backend/Ticketing.Backend/backend.pid) || true
        fi
        pkill -f "dotnet.*Ticketing.Api" || true
      working-directory: ${{ github.workspace }}
    
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 7
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-results
        path: frontend/test-results/
        retention-days: 7









